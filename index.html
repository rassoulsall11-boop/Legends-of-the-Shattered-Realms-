<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>FRACTURE</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#050508">

<style>
html,body{
  margin:0;
  background:#050508;
  overflow:hidden;
}
canvas{
  image-rendering:pixelated;
}

/* Overlay optimisé (pas de reflow) */
#overlay{
  position:fixed;
  inset:0;
  opacity:0;
  pointer-events:none;
  background:#000;
  color:#0ff;
  font-family:monospace;
  font-size:14px;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  z-index:999;
  transition:opacity .3s ease;
}
#overlay.active{
  opacity:1;
  pointer-events:auto;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

<div id="overlay">SAVE FILE CORRUPTED<br>RECOVERY MODE…</div>

<script>
// ===================================================
// SAVE SYSTEM (SAFE)
// ===================================================
const SAVE_KEY="FRACTURE_SAVE";

const Save={
  load(){
    try{
      return JSON.parse(localStorage.getItem(SAVE_KEY)) ||
        {level:1,deaths:0,ach:{},corrupted:false};
    }catch{
      return {level:1,deaths:0,ach:{},corrupted:false};
    }
  },
  save(d){
    localStorage.setItem(SAVE_KEY,JSON.stringify(d));
  },
  fakeCorrupt(){
    const s=this.load();
    if(s.corrupted) return;
    s.corrupted=true;
    s._backup=btoa(JSON.stringify({...s,corrupted:false}));
    this.save(s);
  },
  restore(){
    const s=this.load();
    if(s._backup){
      const r=JSON.parse(atob(s._backup));
      r.corrupted=false;
      delete r._backup;
      this.save(r);
      return r;
    }
    return s;
  }
};

// ===================================================
// META STATE
// ===================================================
const Meta={
  gravity:600,
  invert:false
};

// ===================================================
// GLITCH SHADER (STABLE)
// ===================================================
class Glitch extends Phaser.Renderer.WebGL.Pipelines.PostFXPipeline{
  constructor(game){
    super({
      game,
      fragShader:`
      precision mediump float;
      uniform sampler2D uMainSampler;
      uniform float t;
      varying vec2 outTexCoord;

      float rand(vec2 c){
        return fract(sin(dot(c,vec2(12.9898,78.233)))*43758.5453);
      }

      void main(){
        vec2 uv=outTexCoord;
        float g=rand(vec2(floor(uv.y*240.0),floor(t*60.0)));
        uv.x+=step(0.97,g)*0.05;
        vec4 c=texture2D(uMainSampler,uv);
        c.rgb+=g*0.2;
        gl_FragColor=c;
      }`
    });
  }
}

// ===================================================
// SCENES
// ===================================================
class Boot extends Phaser.Scene{
  create(){
    const g=this.make.graphics({add:false});

    g.fillStyle(0x00ffff).fillRect(0,0,16,16).generateTexture("player",16,16);
    g.clear();
    g.fillStyle(0xff0055).fillRect(0,0,16,16).generateTexture("boss",16,16);
    g.clear();
    g.fillStyle(0x333344).fillRect(0,0,32,8).generateTexture("ground",32,8);

    if(this.game.renderer.type===Phaser.WEBGL){
      if(!this.renderer.pipelines.get("glitch")){
        this.renderer.pipelines.addPostPipeline("glitch",Glitch);
      }
    }

    this.scene.start("Game");
  }
}

class Game extends Phaser.Scene{
  create(){
    this.save=Save.load();
    this.physics.world.gravity.y=Meta.gravity;

    this.cameras.main.setPostPipeline("glitch");

    this.player=this.physics.add.sprite(30,100,"player");
    this.player.setCollideWorldBounds(true);

    this.platforms=this.physics.add.staticGroup();
    for(let i=0;i<8+this.save.level;i++){
      this.platforms.create(80*i,200+Math.sin(i)*40,"ground");
    }

    this.physics.add.collider(this.player,this.platforms);
    this.cursors=this.input.keyboard.createCursorKeys();

    if(this.save.level%3===0){
      this.spawnBoss();
    }

    if(this.save.corrupted){
      const o=document.getElementById("overlay");
      o.classList.add("active");
      Meta.invert=true;
      this.time.delayedCall(3000,()=>{
        Save.restore();
        Meta.invert=false;
        o.classList.remove("active");
      });
    }
  }

  spawnBoss(){
    this.boss=this.physics.add.sprite(200,100,"boss").setScale(2);
    this.boss.hp=3;
    this.boss.body.allowGravity=false;

    this.physics.add.overlap(this.player,this.boss,()=>{
      if(this.player.body.velocity.y>0 && this.player.y<this.boss.y-10){
        this.boss.hp--;
        this.player.setVelocityY(-220);
        this.cameras.main.shake(120,0.015);

        if(this.boss.hp<=0){
          this.boss.destroy();
          this.boss=null;
          Save.fakeCorrupt();
        }
      }else{
        this.handleDeath();
      }
    });
  }

  handleDeath(){
    this.save.deaths++;
    if(this.save.deaths>=20) this.save.ach.obsession=true;
    Save.save(this.save);
    this.scene.restart();
  }

  update(time){
    const p=this.cameras.main.getPostPipeline("glitch");
    if(p) p.setFloat1("t",time*0.001);

    const dir=Meta.invert?-1:1;
    if(this.cursors.left.isDown) this.player.setVelocityX(-120*dir);
    else if(this.cursors.right.isDown) this.player.setVelocityX(120*dir);
    else this.player.setVelocityX(0);

    if(this.cursors.up.isDown && this.player.body.blocked.down){
      this.player.setVelocityY(-300);
    }

    if(this.boss){
      if(Math.abs(this.boss.x-this.player.x)<120){
        this.physics.moveToObject(this.boss,this.player,60);
      }else{
        this.boss.setVelocityX(0);
      }
    }

    if(this.player.x>250 && !this.boss){
      this.save.level++;
      Save.save(this.save);

      if(this.save.level>=10 && this.save.ach.obsession){
        this.scene.start("MetaEnd");
      }else{
        this.scene.restart();
      }
    }

    if(this.player.y>300){
      this.handleDeath();
    }
  }
}

class MetaEnd extends Phaser.Scene{
  create(){
    this.add.text(20,80,
`TU AS VU AU-DELÀ DU JEU.

MERCI D'AVOIR INSISTÉ.`,
    {font:"14px monospace",color:"#00ffff"});
  }
}

// ===================================================
// GAME INIT
// ===================================================
new Phaser.Game({
  type:Phaser.WEBGL,
  width:320,
  height:240,
  zoom:2,
  pixelArt:true,
  physics:{default:"arcade"},
  scene:[Boot,Game,MetaEnd]
});
</script>
</body>
</html>
